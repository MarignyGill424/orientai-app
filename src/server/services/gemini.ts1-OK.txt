import { GoogleGenerativeAI } from '@google/generative-ai';
import dotenv from "dotenv";
import path from "path";

dotenv.config({ path: path.resolve(process.cwd(), ".env") });

const GEMINI_API_KEY = process.env.GEMINI_API_KEY;
console.log("üîë Cl√© Gemini charg√©e :", GEMINI_API_KEY?.slice(0, 5));

if (!GEMINI_API_KEY) {
  console.warn("‚ö†Ô∏è Cl√© API Gemini manquante. R√©ponse simul√©e activ√©e.");
}

const ai = GEMINI_API_KEY ? new GoogleGenerativeAI(GEMINI_API_KEY) : null;

function normalizeGeminiResponse(parsed: any) {
  const rawMetiers = parsed.recommandations_carrieres || [];

  const metiers = rawMetiers.map((m: any) => ({
    titre: m.titre || "M√©tier sans titre",
    description: m.description || "",
    pourquoi_innovant_non_traditionnel: m.pourquoi_innovant_non_traditionnel || "",
    competences_cles: m.competences_cles || [],
    etapes_concretes: m.etapes_concretes || [],
  }));

  return {
    analyse_profil: parsed.analyse_profil || null,
    recommandations_carrieres: metiers,
    conseils_generaux: parsed.conseils_generaux || { recommandations: [] }
  };
}

async function generateProfilPrincipal(formulaire: any) {
  if (!ai) throw new Error("Gemini API non initialis√©e");
  const model = ai.getGenerativeModel({ model: "gemini-2.5-flash" });

  const prompt = `Tu es un expert en orientation scolaire et professionnelle.

Analyse le profil suivant et g√©n√®re une r√©ponse STRICTEMENT au format JSON avec les cl√©s suivantes :
- analyse_profil
- recommandations_carrieres (tableau de 3 objets avec les cl√©s : titre, description, pourquoi_innovant_non_traditionnel, competences_cles, etapes_concretes)
- conseils_generaux (avec la cl√© recommandations, tableau de phrases)

Ne commente pas. Ne reformule pas. Ne mets aucun texte hors du JSON.

Profil :
${JSON.stringify(formulaire, null, 2)}`;

  const result = await model.generateContent({
    contents: [{ role: "user", parts: [{ text: prompt }] }],
    generationConfig: { responseMimeType: "application/json" }
  });

  const response = await result.response.text();
  console.log("üßæ √âtape 1 - Profil principal :", response);
  return JSON.parse(response);
}

async function generateInterpretations(formulaire: any) {
  if (!ai) throw new Error("Gemini API non initialis√©e");
  const model = ai.getGenerativeModel({ model: "gemini-2.5-flash" });

  console.log("üì• Donn√©es re√ßues pour interpr√©tation :", {
    ileDeserte: formulaire.ileDeserte,
    videos: formulaire.videos
  });

  let interpretation_ileDeserte = "Interpr√©tation non disponible";
  let interpretation_videos = "Interpr√©tation non disponible";

  try {
    const promptIle = `Un¬∑e ado a choisi comme objet pour une √Æle d√©serte : "${formulaire.ileDeserte || "Aucune s√©lection"}".
Explique ce que ce choix r√©v√®le sur sa personnalit√©, ses valeurs ou ses besoins.
R√©ponds en une phrase claire.`;

    const resultIle = await model.generateContent({
      contents: [{ role: "user", parts: [{ text: promptIle }] }],
    });

    interpretation_ileDeserte = (await resultIle.response.text()).trim();
    console.log("üß† R√©ponse brute √Æle d√©serte :", interpretation_ileDeserte);
  } catch (error) {
    console.error("‚ùå Erreur Gemini √Æle d√©serte :", error);
  }

  try {
    const promptVideos = `Un¬∑e ado a indiqu√© que ses vid√©os pr√©f√©r√©es sont : "${formulaire.videos || "Aucune s√©lection"}".
Explique ce que cela r√©v√®le sur sa sensibilit√©, ses centres d‚Äôint√©r√™t ou sa mani√®re d‚Äôapprendre.
R√©ponds en une phrase claire.`;

    const resultVideos = await model.generateContent({
      contents: [{ role: "user", parts: [{ text: promptVideos }] }],
    });

    interpretation_videos = (await resultVideos.response.text()).trim();
    console.log("üé¨ R√©ponse brute vid√©os :", interpretation_videos);
  } catch (error) {
    console.error("‚ùå Erreur Gemini vid√©os :", error);
  }

  return {
    ileDeserte: formulaire.ileDeserte || "Aucune s√©lection",
    interpretation_ileDeserte: interpretation_ileDeserte || "Interpr√©tation non disponible",
    videos: formulaire.videos || "Aucune s√©lection",
    interpretation_videos: interpretation_videos || "Interpr√©tation non disponible"
  };
}

export async function generateOrientationSuggestions(formulaire: any) {
  if (!ai) {
    console.log("üß™ Mode simul√© activ√©");
    return {
      analyse_profil: {
        resume: "Profil simul√©",
        points_forts: ["Cr√©atif", "Curieux"]
      },
      recommandations_carrieres: [],
      conseils_generaux: { recommandations: [] },
      ileDeserte: "Aucune s√©lection",
      interpretation_ileDeserte: "Interpr√©tation non disponible",
      videos: "Aucune s√©lection",
      interpretation_videos: "Interpr√©tation non disponible"
    };
  }

  try {
    const profil = await generateProfilPrincipal(formulaire);
    const interpretations = await generateInterpretations(formulaire);

    const final = {
      ...normalizeGeminiResponse(profil),
      ...interpretations
    };

    console.log("üì¶ R√©ponse fusionn√©e :", JSON.stringify(final, null, 2));
    return final;
  } catch (error) {
    const message = (error as Error).message || "";

    if (message.includes("model is overloaded") || message.includes("503")) {
      console.error("‚ùå Le mod√®le Gemini est surcharg√©. R√©essaie plus tard.");
      throw new Error("Le mod√®le est temporairement indisponible. R√©essaie dans quelques instants.");
    }

    console.error("‚ùå Erreur Gemini :", error);
    throw new Error(`Erreur Gemini : ${message}`);
  }
}
