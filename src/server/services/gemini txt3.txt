import { GoogleGenerativeAI } from '@google/generative-ai';
import dotenv from "dotenv";
import path from "path";

// ‚úÖ Chargement explicite du fichier .env
dotenv.config({ path: path.resolve(process.cwd(), ".env") });

const GEMINI_API_KEY = process.env.GEMINI_API_KEY;
console.log("üîë Cl√© Gemini charg√©e :", GEMINI_API_KEY);
console.log("üîç Cl√© API Gemini d√©tect√©e :", GEMINI_API_KEY?.slice(0, 5));

if (!GEMINI_API_KEY) {
  console.warn("‚ö†Ô∏è Cl√© API Gemini manquante. R√©ponse simul√©e activ√©e.");
}

const ai = GEMINI_API_KEY ? new GoogleGenerativeAI(GEMINI_API_KEY) : null;

// ‚úÖ Fonction de normalisation robuste
function normalizeGeminiResponse(parsed: any) {
  const rawMetiers = parsed.recommandations_carrieres || parsed.recommandations_carriere || [];

  const metiers = rawMetiers.map((m: any) => ({
   titre: m.titre || m.nom_metier || m.titre_carriere || "M√©tier sans titre",

    description: m.description || "",
    pourquoi_innovant_non_traditionnel:
      m.pourquoi_innovant_non_traditionnel ||
      m.pourquoi_ca_correspond ||
      m.aspects_innovants_non_traditionnels ||
      "",
    lien_profil: m.lien_profil || [],
    competences_cles: m.competences_cles || [],
    etapes_concretes: m.etapes_concretes || [],
    ...m
  }));

  return {
    analyse_profil:
      parsed.analyse_profil ||
      parsed.profil_analyse ||
      parsed.analyse_globale ||
      null,
    recommandations_carrieres: metiers,
    conseils_generaux: Array.isArray(parsed.conseils_generaux)
      ? { recommandations: parsed.conseils_generaux }
      : parsed.conseils_generaux || {
          recommandations: [
            "Aucun conseil sp√©cifique n‚Äôa √©t√© g√©n√©r√©. Tu peux explorer les m√©tiers propos√©s pour affiner ton projet."
          ]
        }
  };
}

// ‚úÖ Fonction principale

export async function generateOrientationSuggestions(formulaire: any) {
  const ai = GEMINI_API_KEY ? new GoogleGenerativeAI(GEMINI_API_KEY) : null;

  if (!ai) {
    console.log("üß™ Mode simul√© activ√©");
    return {
      analyse_profil: {
        resume: "Profil analys√©. Voici une r√©ponse simul√©e.",
        points_forts: ["Curieux", "Cr√©atif", "Orient√© vers l'humain"]
      },
      recommandations_carrieres: [
        {
          titre: "Designer d'exp√©riences immersives",
          description: "Cr√©e des environnements interactifs en r√©alit√© augment√©e.",
          pourquoi_innovant_non_traditionnel: "Fusion entre art, technologie et narration.",
          competences_cles: ["Unity", "Design 3D", "Storytelling"],
          etapes_concretes: ["Explorer Unity ou Unreal Engine", "Suivre un MOOC sur XR design"]
        }
      ],
      conseils_generaux: {
        recommandations: [
          "Participer √† un hackathon",
          "Cr√©er un portfolio en ligne",
          "D√©velopper sa communication visuelle"
        ]
      }
    };
  }

  console.log("üöÄ Initialisation du mod√®le Gemini...");
  const model = ai.getGenerativeModel({ model: "gemini-2.5-flash" });

  const prompt = generatePrompt(formulaire); // ta fonction qui g√©n√®re le prompt
  const result = await model.generateContent({
  contents: [{ role: "user", parts: [{ text: prompt }] }],
  generationConfig: {
    responseMimeType: "application/json"
  }
});

  const response = result.response.text();

  try {
    const parsed = JSON.parse(response);
    return normalizeGeminiResponse(parsed);
  } catch (error) {
    console.error("‚ùå Erreur de parsing JSON Gemini :", error);
    throw new Error("R√©ponse Gemini invalide");
  }
}


// ‚úÖ G√©n√©ration du prompt
function generatePrompt(formData: any) {
  return `Tu es un expert en orientation professionnelle sp√©cialis√© dans l'accompagnement des jeunes. Analyse ce profil et g√©n√®re des recommandations de carri√®re personnalis√©es, en mettant l'accent sur les m√©tiers innovants et non-traditionnels.

PROFIL √Ä ANALYSER:
${JSON.stringify(formData, null, 2)}

INSTRUCTIONS:
1. Propose des carri√®res innovantes et √©mergentes
2. Inclus des m√©tiers non-traditionnels 
3. Consid√®re les nouvelles technologies et tendances
4. Personnalise selon les valeurs et aspirations
5. Donne des √©tapes concr√®tes et r√©alisables

R√©ponds uniquement en JSON valide selon le sch√©ma fourni.`;
}
