import React from "react";
import { useLocation, useNavigate } from "react-router-dom";
import { OrientationResults } from "../types";
import TypewriterText from "../components/TypewriterText";

export default function Resultats() {
  const location = useLocation();
  const navigate = useNavigate();
  const profil = location.state as OrientationResults;

  console.log("ğŸ“¦ Profil reÃ§u :", profil);

  // ğŸ› ï¸ Fonction pour tÃ©lÃ©charger les conseils
  function downloadConseils(conseils: Record<string, string>) {
    const contenu = Object.entries(conseils)
      .map(([key, value]) => `ğŸ”¹ ${key.replaceAll("_", " ").toUpperCase()}\n${value}\n`)
      .join("\n\n");

    const blob = new Blob([contenu], { type: "text/plain;charset=utf-8" });
    const url = URL.createObjectURL(blob);

    const link = document.createElement("a");
    link.href = url;
    link.download = "conseils_orientation.txt";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  if (!profil || typeof profil !== "object") {
    return (
      <div style={{ padding: "2rem" }}>
        <h1>âŒ Aucun profil Ã  afficher</h1>
        <p>Il semble que les donnÃ©es nâ€™aient pas Ã©tÃ© transmises correctement.</p>
        <button onClick={() => navigate("/")}>ğŸ”™ Retour au questionnaire</button>
      </div>
    );
  }

  return (
    <div style={{ padding: "2rem" }}>
      <h1>ğŸ“ Ton profil dâ€™orientation</h1>

      {profil.analyse_profil ? (
        <>
          <h2>ğŸ§  Analyse du profil</h2>
          {typeof profil.analyse_profil === "string" ? (
            <TypewriterText text={profil.analyse_profil} speed={25} />
          ) : (
            <ul>
              {Object.entries(profil.analyse_profil).map(([key, value]) => (
                <li key={key}>
                  <strong>{key.replaceAll("_", " ")} :</strong> {value}
                </li>
              ))}
            </ul>
          )}
        </>
      ) : (
        <p>Profil de personnalitÃ© non disponible.</p>
      )}

      {Array.isArray(profil.recommandations_carrieres) && profil.recommandations_carrieres.length > 0 ? (
        <>
          <h2>ğŸ¯ MÃ©tiers suggÃ©rÃ©s</h2>
          <ul>
            {profil.recommandations_carrieres.map((metier, index) => (
              <li key={index} style={{ marginBottom: "1rem" }}>
                <strong>{metier.titre}</strong> â€” {metier.description}
                {metier.pourquoi_innovant_non_traditionnel && (
                  <p><em>ğŸ’¡ Pourquoi câ€™est innovant :</em> {metier.pourquoi_innovant_non_traditionnel}</p>
                )}
              </li>
            ))}
          </ul>
        </>
      ) : (
        <p>Aucun mÃ©tier suggÃ©rÃ© pour lâ€™instant.</p>
      )}

      <h2>ğŸï¸ Ton Ã®le dÃ©serte</h2>
      {profil.ileDeserte ? (
        <p>
          <strong>{profil.ileDeserte}</strong> â€” {profil.interpretation_ileDeserte || "InterprÃ©tation non disponible"}
        </p>
      ) : (
        <p>Aucune sÃ©lection pour lâ€™Ã®le dÃ©serte.</p>
      )}

      <h2>ğŸ¬ Tes vidÃ©os prÃ©fÃ©rÃ©es</h2>
      {profil.videos ? (
        <p>
          <strong>{profil.videos}</strong> â€” {profil.interpretation_videos || "InterprÃ©tation non disponible"}
        </p>
      ) : (
        <p>Aucune vidÃ©o sÃ©lectionnÃ©e pour le moment.</p>
      )}

      {profil.conseils_generaux && typeof profil.conseils_generaux === "object" ? (
        <>
          <h2>ğŸ“š Conseils gÃ©nÃ©raux</h2>
          <ul style={{ listStyle: "none", paddingLeft: 0 }}>
            {Object.entries(profil.conseils_generaux).map(([key, value]) => {
              let icon = "ğŸ§­";
              if (key.toLowerCase().includes("formation")) icon = "ğŸ“";
              else if (key.toLowerCase().includes("carriere")) icon = "ğŸ’¼";
              else if (key.toLowerCase().includes("bien_etre") || key.toLowerCase().includes("mental")) icon = "ğŸ§˜";
              else if (key.toLowerCase().includes("social")) icon = "ğŸ¤";

              return (
                <li key={key} style={{ marginBottom: "1rem", background: "#f9f9f9", padding: "1rem", borderRadius: "8px" }}>
                  <strong>{icon} {key.replaceAll("_", " ").toUpperCase()}</strong>
                  <p style={{ marginTop: "0.5rem" }}>{value}</p>
                </li>
              );
            })}
          </ul>

          <div style={{ marginTop: "1rem" }}>
            <button onClick={() => downloadConseils(profil.conseils_generaux)}>
              ğŸ“¥ TÃ©lÃ©charger mes conseils
            </button>
          </div>
        </>
      ) : (
        <p>Aucun conseil disponible pour le moment.</p>
      )}

      {profil.message_inspirant && (
        <blockquote style={{ fontStyle: "italic", marginTop: "2rem" }}>
          ğŸ’¬ {profil.message_inspirant}
        </blockquote>
      )}

      <div style={{ marginTop: "2rem" }}>
        <button onClick={() => navigate("/")}>ğŸ” Recommencer le questionnaire</button>
      </div>
    </div>
  );
}
