import React, { useEffect, useState } from "react";
import { useLocation, useNavigate } from "react-router-dom";
import { OrientationResults } from "../types";
import TypewriterText from "../components/TypewriterText";
import "./Resultats.css";
import jsPDF from "jspdf";
import html2canvas from "html2canvas";

export default function Resultats() {
  const location = useLocation();
  const navigate = useNavigate();
  const [profil, setProfil] = useState<OrientationResults | null>(null);
  const [chargement, setChargement] = useState(true);

  useEffect(() => {
    const data = location.state as OrientationResults;
    if (data) {
      setProfil(data);
    }
    setChargement(false);
  }, [location.state]);

  function downloadConseils(conseils: Record<string, string>) {
    const contenu = Object.entries(conseils)
      .map(([key, value]) => `ğŸ”¹ ${key.replaceAll("_", " ").toUpperCase()}\n${value}\n`)
      .join("\n\n");

    const blob = new Blob([contenu], { type: "text/plain;charset=utf-8" });
    const url = URL.createObjectURL(blob);

    const link = document.createElement("a");
    link.href = url;
    link.download = "conseils_orientation.txt";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  function downloadProfilComplet(profil: OrientationResults) {
    const contenu = [
      `ğŸ§  Analyse du profil:\n${typeof profil.analyse_profil === "string" ? profil.analyse_profil : JSON.stringify(profil.analyse_profil, null, 2)}`,
      `\nğŸ¯ MÃ©tiers suggÃ©rÃ©s:\n${profil.recommandations_carrieres.map(m => `- ${m.titre}: ${m.description}`).join("\n")}`,
      `\nğŸï¸ Ãle dÃ©serte: ${profil.ileDeserte} â†’ ${profil.interpretation_ileDeserte}`,
      `\nğŸ¬ VidÃ©os prÃ©fÃ©rÃ©es: ${profil.videos} â†’ ${profil.interpretation_videos}`,
      `\nğŸ“š Conseils:\n${Object.entries(profil.conseils_generaux || {}).map(([k, v]) => `ğŸ”¹ ${k.toUpperCase()}: ${v}`).join("\n")}`,
      `\nğŸ’¬ Message inspirant: ${profil.message_inspirant || "Non disponible"}`
    ].join("\n\n");

    const blob = new Blob([contenu], { type: "text/plain;charset=utf-8" });
    const url = URL.createObjectURL(blob);

    const link = document.createElement("a");
    link.href = url;
    link.download = "profil_orientation_complet.txt";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  async function handleExportPDF() {
    const element = document.body;
    const canvas = await html2canvas(element);
    const imgData = canvas.toDataURL("image/png");
    const pdf = new jsPDF("p", "mm", "a4");
    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
    pdf.addImage(imgData, "PNG", 0, 0, pdfWidth, pdfHeight);
    pdf.save("profil_orientation.pdf");
  }

  if (chargement) {
    return (
      <div style={{ padding: "2rem", textAlign: "center" }}>
        <h2>â³ Ton profil est en cours de crÃ©ationâ€¦</h2>
        <p>Merci de patienter, cela peut prendre jusquâ€™Ã  2 minutes ğŸ™</p>
        <div className="loader" />
      </div>
    );
  }

  if (!profil || typeof profil !== "object") {
    return (
      <div style={{ padding: "2rem" }}>
        <h1>âŒ Aucun profil Ã  afficher</h1>
        <p>Il semble que les donnÃ©es nâ€™aient pas Ã©tÃ© transmises correctement.</p>
        <button onClick={() => navigate("/")}>ğŸ”™ Retour au questionnaire</button>
        <pre>{JSON.stringify(profil, null, 2)}</pre>
      </div>
    );
  }

  return (
    <div style={{ padding: "2rem" }}>
      <h1>ğŸ“ Ton profil dâ€™orientation</h1>

      {profil.analyse_profil ? (
        <>
          <h2>ğŸ§  Analyse du profil</h2>
          {typeof profil.analyse_profil === "string" ? (
            <TypewriterText text={profil.analyse_profil} speed={25} />
          ) : (
            <ul>
              {Object.entries(profil.analyse_profil).map(([key, value]) => (
                <li key={key}>
                  <strong>{key.replaceAll("_", " ")} :</strong> {value}
                </li>
              ))}
            </ul>
          )}
        </>
      ) : (
        <p>Profil de personnalitÃ© non disponible.</p>
      )}

      {Array.isArray(profil.recommandations_carrieres) && profil.recommandations_carrieres.length > 0 ? (
        <>
          <h2>ğŸ¯ MÃ©tiers suggÃ©rÃ©s</h2>
          <ul>
            {profil.recommandations_carrieres.map((metier, index) => (
              <li key={index} style={{ marginBottom: "1rem" }}>
                <strong>{metier.titre}</strong> â€” {metier.description}
                {metier.pourquoi_innovant_non_traditionnel && (
                  <p><em>ğŸ’¡ Pourquoi câ€™est innovant :</em> {metier.pourquoi_innovant_non_traditionnel}</p>
                )}
              </li>
            ))}
          </ul>
        </>
      ) : (
        <p>Aucun mÃ©tier suggÃ©rÃ© pour lâ€™instant.</p>
      )}

      <h2>ğŸï¸ Ton Ã®le dÃ©serte</h2>
      <p>
        <strong>{profil.ileDeserte || "Aucune sÃ©lection"}</strong> â€” {profil.interpretation_ileDeserte || "InterprÃ©tation non disponible"}
      </p>

      <h2>ğŸ¬ Tes vidÃ©os prÃ©fÃ©rÃ©es</h2>
      <p>
        <strong>{profil.videos || "Aucune sÃ©lection"}</strong> â€” {profil.interpretation_videos || "InterprÃ©tation non disponible"}
      </p>

      {profil.conseils_generaux && typeof profil.conseils_generaux === "object" ? (
        <>
          <h2>ğŸ“š Conseils gÃ©nÃ©raux</h2>
          <ul style={{ listStyle: "none", paddingLeft: 0 }}>
            {Object.entries(profil.conseils_generaux).map(([key, value]) => {
              let icon = "ğŸ§­";
              if (key.toLowerCase().includes("formation")) icon = "ğŸ“";
              else if (key.toLowerCase().includes("carriere")) icon = "ğŸ’¼";
              else if (key.toLowerCase().includes("bien_etre") || key.toLowerCase().includes("mental")) icon = "ğŸ§˜";
              else if (key.toLowerCase().includes("social")) icon = "ğŸ¤";

              return (
                <li key={key} style={{ marginBottom: "1rem", background: "#f9f9f9", padding: "1rem", borderRadius: "8px" }}>
                  <strong>{icon} {key.replaceAll("_", " ").toUpperCase()}</strong>
                  <p style={{ marginTop: "0.5rem" }}>{value}</p>
                </li>
              );
            })}
          </ul>

          <div style={{ marginTop: "1rem" }}>
            <button onClick={() => downloadConseils(profil.conseils_generaux)}>
              ğŸ“¥ TÃ©lÃ©charger mes conseils
            </button>
          </div>

          <div style={{ marginTop: "1rem" }}>
            <button onClick={() => downloadProfilComplet(profil)}>
              ğŸ“„ TÃ©lÃ©charger mon profil complet
            </button>
          </div>

          <div style={{ marginTop: "1rem" }}>
            <button onClick={handleExportPDF}>
              ğŸ§¾ Exporter en PDF
            </button>
          </div>
        </>
      ) : (
        <p>Aucun conseil disponible pour le moment.</p>
      )}

      {profil.message_inspirant && (
        <blockquote style={{ fontStyle: "italic", marginTop: "2rem" }}>
          ğŸ’¬ {profil.message_inspirant}
        </blockquote>
      )}


{/* ğŸŒŸ Message motivant basÃ© sur la fiertÃ© */}
{profil?.fierte && profil.fierte.length > 10 && (
  <div style={{ marginTop: "2rem", padding: "1rem", background: "#e6ffed", borderLeft: "4px solid #38a169", borderRadius: "8px" }}>
    <h3 style={{ marginBottom: "0.5rem" }}>ğŸŒŸ Ce dont tu peux Ãªtre fierÂ·e</h3>
    <p style={{ fontStyle: "italic", marginBottom: "0.5rem" }}>Â« {profil.fierte} Â»</p>
    <p style={{ fontSize: "0.9rem" }}>
      Ce souvenir montre que tu es capable de belles choses. Garde-le en tÃªte quand tu doutes â€” il est la preuve que tu avances dÃ©jÃ .
    </p>
  </div>
)}

{/* ğŸ“Š Message motivant basÃ© sur le niveau de confiance */}
{typeof profil?.confiance === "number" && (
  <div style={{ marginTop: "2rem", padding: "1rem", background: "#f3e8ff", borderLeft: "4px solid #9f7aea", borderRadius: "8px" }}>
    {profil.confiance >= 8 && (
      <p style={{ fontStyle: "italic" }}>
        ğŸ’ª Tu crois en toi, et Ã§a se sentâ€¯! Cette confiance est une force prÃ©cieuse pour avancer.
      </p>
    )}
    {profil.confiance >= 5 && profil.confiance < 8 && (
      <p style={{ fontStyle: "italic" }}>
        ğŸŒ± Tu es sur le bon chemin. Ta confiance peut grandir avec chaque petite victoire.
      </p>
    )}
    {profil.confiance < 5 && (
      <p style={{ fontStyle: "italic" }}>
        ğŸ’¡ MÃªme si tu doutes, tu as dÃ©jÃ  fait un grand pas. Câ€™est le dÃ©but dâ€™un beau chemin.
      </p>
    )}
  </div>
)}



      <div className="no-print" style={{ marginTop: "2rem" }}>
        <button onClick={() => window.print()}>ğŸ–¨ï¸ Imprimer mon profil</button>
      </div>

      <div style={{ marginTop: "2rem" }}>
        <button onClick={() => navigate("/")}>
          ğŸ” Recommencer le questionnaire
        </button>
      </div>
    </div>
  );
}
