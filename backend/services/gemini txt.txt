import { GoogleGenerativeAI } from '@google/generative-ai';
import dotenv from "dotenv";
import path from "path";

// ‚úÖ Chargement explicite du fichier .env
dotenv.config({ path: path.resolve(process.cwd(), ".env") });

const GEMINI_API_KEY = process.env.GEMINI_API_KEY;
console.log("üîë Cl√© Gemini charg√©e :", GEMINI_API_KEY);
console.log("üîç Cl√© API Gemini d√©tect√©e :", GEMINI_API_KEY?.slice(0, 5));

if (!GEMINI_API_KEY) {
  console.warn("‚ö†Ô∏è Cl√© API Gemini manquante. R√©ponse simul√©e activ√©e.");
}

const ai = GEMINI_API_KEY ? new GoogleGenerativeAI(GEMINI_API_KEY) : null;

// ‚úÖ Fonction de normalisation robuste
function normalizeGeminiResponse(parsed: any) {
  const rawMetiers = parsed.recommandations_carrieres || parsed.recommandations_carriere || [];

  const metiers = rawMetiers.map((m: any) => ({
   titre: m.titre || m.nom_metier || m.titre_carriere || "M√©tier sans titre",

    description: m.description || "",
    pourquoi_innovant_non_traditionnel:
      m.pourquoi_innovant_non_traditionnel ||
      m.pourquoi_ca_correspond ||
      m.aspects_innovants_non_traditionnels ||
      "",
    lien_profil: m.lien_profil || [],
    competences_cles: m.competences_cles || [],
    etapes_concretes: m.etapes_concretes || [],
    ...m
  }));

  return {
    analyse_profil:
      parsed.analyse_profil ||
      parsed.profil_analyse ||
      parsed.analyse_globale ||
      null,
    recommandations_carrieres: metiers,
    conseils_generaux: Array.isArray(parsed.conseils_generaux)
      ? { recommandations: parsed.conseils_generaux }
      : parsed.conseils_generaux || {
          recommandations: [
            "Aucun conseil sp√©cifique n‚Äôa √©t√© g√©n√©r√©. Tu peux explorer les m√©tiers propos√©s pour affiner ton projet."
          ]
        }
  };
}

// ‚úÖ Fonction principale
export async function generateOrientationSuggestions(formData: any) {
  console.log("üì• Donn√©es re√ßues :", JSON.stringify(formData, null, 2));

  try {
    const prompt = generatePrompt(formData);
    console.log("üì§ Prompt g√©n√©r√© :", prompt);

    // ‚úÖ Mode simul√© si pas de cl√© API
    if (!ai) {
      console.log("üß™ Mode simul√© activ√©");
      return {
        analyse_profil: {
          resume: "Profil analys√©. Voici une r√©ponse simul√©e.",
          points_forts: ["Curieux", "Cr√©atif", "Orient√© vers l'humain"]
        },
        recommandations_carrieres: [
          {
            titre: "Designer d'exp√©riences immersives",
            description: "Cr√©e des environnements interactifs en r√©alit√© augment√©e.",
            pourquoi_innovant_non_traditionnel: "Fusion entre art, technologie et narration.",
            competences_cles: ["Unity", "Design 3D", "Storytelling"],
            etapes_concretes: ["Explorer Unity ou Unreal Engine", "Suivre un MOOC sur XR design"]
          }
        ],
        conseils_generaux: {
          recommandations: [
            "Participer √† un hackathon",
            "Cr√©er un portfolio en ligne",
            "D√©velopper sa communication visuelle"
          ]
        }
      };
    }

console.log("üöÄ Initialisation du mod√®le Gemini...");

if (!ai) {
  console.log("üß™ Mode simul√© activ√©");
  return {
  analyse_profil: {
    resume: "Profil analys√©. Voici une r√©ponse simul√©e.",
    points_forts: ["Curieux", "Cr√©atif", "Orient√© vers l'humain"]
  },
  recommandations_carrieres: [
    {
      titre: "Designer d'exp√©riences immersives",
      description: "Cr√©e des environnements interactifs en r√©alit√© augment√©e.",
      pourquoi_innovant_non_traditionnel: "Fusion entre art, technologie et narration.",
      competences_cles: ["Unity", "Design 3D", "Storytelling"],
      etapes_concretes: ["Explorer Unity ou Unreal Engine", "Suivre un MOOC sur XR design"]
    }
  ],
  conseils_generaux: {
    recommandations: [
      "Participer √† un hackathon",
      "Cr√©er un portfolio en ligne",
      "D√©velopper sa communication visuelle"
    ]
  }
};
 // ta r√©ponse simul√©e
};
} else {

console.log("üöÄ Initialisation du mod√®le Gemini...");

  conseils_generaux: {
    recommandations: [
      "Participer √† un hackathon",
      "Cr√©er un portfolio en ligne",
      "D√©velopper sa communication visuelle"
    ]
  }
};
 // ta r√©ponse simul√©e
} else {
  console.log("üöÄ Initialisation du mod√®le Gemini...");
  const model = ai.getGenerativeModel({ model: 'gemini-2.5-flash' });
  ...
}




    const result = await model.generateContent({
      contents: [{ role: "user", parts: [{ text: prompt }] }],
      generationConfig: {
        responseMimeType: "application/json"
      }
    });

console.log("‚úÖ Contenu g√©n√©r√© par Gemini :", result);

    const text = result.response.text();
    console.log("üì® R√©ponse brute de Gemini :", text);

    if (!text) {
      throw new Error("R√©ponse vide de l'IA");
    }

    const jsonStart = text.indexOf("{");
    const jsonEnd = text.lastIndexOf("}");
    const jsonString = text.slice(jsonStart, jsonEnd + 1);

    let parsed;
    try {
      parsed = JSON.parse(jsonString);
    } catch (parseError) {
      console.error("‚ùå Erreur de parsing JSON :", parseError);
      throw new Error("La r√©ponse de Gemini n'est pas un JSON valide.");
    }

    console.log("‚úÖ R√©ponse analys√©e avec succ√®s");

    const normalized = normalizeGeminiResponse(parsed);
    console.log("üì¶ R√©ponse normalis√©e envoy√©e au frontend :", JSON.stringify(normalized, null, 2));

    return normalized;

  } catch (error) {
    console.error("‚ùå Erreur lors de la g√©n√©ration des suggestions :", error);
    throw new Error(`Impossible de g√©n√©rer les suggestions: ${(error as Error).message || String(error)}`);
  }
}

// ‚úÖ G√©n√©ration du prompt
function generatePrompt(formData: any) {
  return `Tu es un expert en orientation professionnelle sp√©cialis√© dans l'accompagnement des jeunes. Analyse ce profil et g√©n√®re des recommandations de carri√®re personnalis√©es, en mettant l'accent sur les m√©tiers innovants et non-traditionnels.

PROFIL √Ä ANALYSER:
${JSON.stringify(formData, null, 2)}

INSTRUCTIONS:
1. Propose des carri√®res innovantes et √©mergentes
2. Inclus des m√©tiers non-traditionnels 
3. Consid√®re les nouvelles technologies et tendances
4. Personnalise selon les valeurs et aspirations
5. Donne des √©tapes concr√®tes et r√©alisables

R√©ponds uniquement en JSON valide selon le sch√©ma fourni.`;
}
