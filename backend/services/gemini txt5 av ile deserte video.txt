import { GoogleGenerativeAI } from '@google/generative-ai';
import dotenv from "dotenv";
import path from "path";

// ‚úÖ Chargement explicite du fichier .env
dotenv.config({ path: path.resolve(process.cwd(), ".env") });

const GEMINI_API_KEY = process.env.GEMINI_API_KEY;
console.log("üîë Cl√© Gemini charg√©e :", GEMINI_API_KEY);
console.log("üîç Cl√© API Gemini d√©tect√©e :", GEMINI_API_KEY?.slice(0, 5));

if (!GEMINI_API_KEY) {
  console.warn("‚ö†Ô∏è Cl√© API Gemini manquante. R√©ponse simul√©e activ√©e.");
}

const ai = GEMINI_API_KEY ? new GoogleGenerativeAI(GEMINI_API_KEY) : null;

// ‚úÖ Fonctions d‚Äôinterpr√©tation
function interpreterIle(reponse?: string): string {
  const map: Record<string, string> = {
    "Carnet et crayon": "la cr√©ativit√© et l‚Äôintrospection",
    "Livre pr√©f√©r√©": "la curiosit√© et l‚Äô√©vasion",
    "Casque audio": "la sensibilit√© musicale",
    "Outil multifonction": "le pragmatisme et l‚Äôautonomie",
    "Objet sentimental": "l‚Äôattachement affectif",
    "Console portable": "le go√ªt du jeu et de l‚Äôimaginaire",
    "Application magique": "l‚Äôenvie de transformer le monde",
    "Animal de compagnie": "l‚Äôempathie et la fid√©lit√©",
    "Nourriture pr√©f√©r√©e": "le plaisir simple et la gourmandise",
    "Miroir ou objet symbolique": "la qu√™te de sens et d‚Äôidentit√©",
    "Autre": "un univers int√©rieur unique",
  };
  return map[reponse || ""] || "non interpr√©t√©";
}

function interpreterVideos(reponse?: string): string {
  const map: Record<string, string> = {
    "Humour": "la cr√©ativit√© comique et la spontan√©it√©",
    "Sport": "l‚Äô√©nergie et l‚Äôesprit d‚Äô√©quipe",
    "Musique": "la sensibilit√© artistique et le rythme",
    "Science": "la curiosit√© intellectuelle",
    "S√©ries": "le go√ªt pour les histoires",
    "Films": "l‚Äôimaginaire et la narration",
    "Autre": "des int√©r√™ts originaux",
  };
  return map[reponse || ""] || "non interpr√©t√©";
}

// ‚úÖ Fonction de normalisation robuste
function normalizeGeminiResponse(parsed: any) {
  const rawMetiers = parsed.recommandations_carrieres || parsed.recommandations_carriere || [];

  const metiers = rawMetiers.map((m: any) => ({
    titre: m.titre || m.nom_metier || m.titre_carriere || "M√©tier sans titre",
    description: m.description || "",
    pourquoi_innovant_non_traditionnel:
      m.pourquoi_innovant_non_traditionnel ||
      m.pourquoi_ca_correspond ||
      m.aspects_innovants_non_traditionnels ||
      "",
    lien_profil: m.lien_profil || [],
    competences_cles: m.competences_cles || [],
    etapes_concretes: m.etapes_concretes || [],
    ...m
  }));

  return {
    analyse_profil:
      parsed.analyse_profil ||
      parsed.profil_analyse ||
      parsed.analyse_globale ||
      null,
    recommandations_carrieres: metiers,
    conseils_generaux: Array.isArray(parsed.conseils_generaux)
      ? { recommandations: parsed.conseils_generaux }
      : parsed.conseils_generaux || {
          recommandations: [
            "Aucun conseil sp√©cifique n‚Äôa √©t√© g√©n√©r√©. Tu peux explorer les m√©tiers propos√©s pour affiner ton projet."
          ]
        }
  };
}

// ‚úÖ Fonction principale
export async function generateOrientationSuggestions(formulaire: any) {
  if (!ai) {
    console.log("üß™ Mode simul√© activ√©");
    return {
      analyse_profil: {
        resume: "Profil analys√©. Voici une r√©ponse simul√©e.",
        points_forts: ["Curieux", "Cr√©atif", "Orient√© vers l'humain"]
      },
      recommandations_carrieres: [
        {
          titre: "Designer d'exp√©riences immersives",
          description: "Cr√©e des environnements interactifs en r√©alit√© augment√©e.",
          pourquoi_innovant_non_traditionnel: "Fusion entre art, technologie et narration.",
          competences_cles: ["Unity", "Design 3D", "Storytelling"],
          etapes_concretes: ["Explorer Unity ou Unreal Engine", "Suivre un MOOC sur XR design"]
        }
      ],
      conseils_generaux: {
        recommandations: [
          "Participer √† un hackathon",
          "Cr√©er un portfolio en ligne",
          "D√©velopper sa communication visuelle"
        ]
      }
    };
  }

  try {
    console.log("üöÄ Initialisation du mod√®le Gemini...");
    const model = ai.getGenerativeModel({ model: "gemini-2.5-flash" });

    const prompt = generatePrompt(formulaire);
    const result = await model.generateContent({
      contents: [{ role: "user", parts: [{ text: prompt }] }],
      generationConfig: {
        responseMimeType: "application/json"
      }
    });

    const response = result.response.text();
    console.log("üì® R√©ponse brute de Gemini :", response);

    const parsed = JSON.parse(response);
    const normalized = normalizeGeminiResponse(parsed);
    console.log("üì¶ R√©ponse normalis√©e :", JSON.stringify(normalized, null, 2));

    return normalized;
  } catch (error) {
    console.error("‚ùå Erreur lors de la g√©n√©ration des suggestions :", error);
    throw new Error(`Impossible de g√©n√©rer les suggestions: ${(error as Error).message || String(error)}`);
  }
}

// ‚úÖ G√©n√©ration du prompt enrichi
function generatePrompt(formData: any) {
  const ile = formData.ileDeserte
    ? `Sur une √Æle d√©serte, il/elle emporterait : ${formData.ileDeserte}. Cela r√©v√®le ${interpreterIle(formData.ileDeserte)}.`
    : "Aucune r√©ponse sur l'√Æle d√©serte.";

  const video = formData.videos
    ? `Ses vid√©os pr√©f√©r√©es sont de type : ${formData.videos}. Cela montre ${interpreterVideos(formData.videos)}.`
    : "Aucune vid√©o pr√©f√©r√©e renseign√©e.";

  return `Tu es un expert en orientation professionnelle sp√©cialis√© dans l'accompagnement des jeunes. Analyse ce profil et g√©n√®re des recommandations de carri√®re personnalis√©es, en mettant l'accent sur les m√©tiers innovants et non-traditionnels.

D√âTAILS COMPL√âMENTAIRES :
${ile}
${video}

PROFIL √Ä ANALYSER:
${JSON.stringify(formData, null, 2)}

INSTRUCTIONS:
1. Propose des carri√®res innovantes et √©mergentes
2. Inclus des m√©tiers non-traditionnels 
3. Consid√®re les nouvelles technologies et tendances
4. Personnalise selon les valeurs et aspirations
5. Donne des √©tapes concr√®tes et r√©alisables

R√©ponds uniquement en JSON valide selon le sch√©ma fourni.`;
}
