import { GoogleAI } from "@google/genai";
import dotenv from "dotenv";
import path from "path";

dotenv.config({ path: path.resolve(process.cwd(), ".env") });

const GEMINI_API_KEY = process.env.GEMINI_API_KEY;
console.log("üîë Cl√© Gemini charg√©e :", GEMINI_API_KEY?.slice(0, 5));

if (!GEMINI_API_KEY) {
  console.warn("‚ö†Ô∏è Cl√© API Gemini manquante. R√©ponse simul√©e activ√©e.");
  throw new Error("Cl√© GEMINI_API_KEY absente en production");
}

// ‚úÖ Initialisation du client Gemini
const ai = new GoogleAI({ apiKey: GEMINI_API_KEY });
console.log("üß† Objet Gemini :", ai ? "‚úÖ OK" : "‚ùå Ind√©fini");

// ----------------------------------------------------
// Normalisation des r√©ponses
function normalizeGeminiResponse(parsed: any) {
  const rawMetiers = parsed.recommandations_carrieres || [];
  const metiers = rawMetiers.map((m: any) => ({
    titre: m.titre || "M√©tier sans titre",
    description: m.description || "",
    pourquoi_innovant_non_traditionnel: m.pourquoi_innovant_non_traditionnel || "",
    competences_cles: m.competences_cles || [],
    etapes_concretes: m.etapes_concretes || [],
  }));
  return {
    introduction: parsed.introduction || null,
    analyse_profil: parsed.analyse_profil || null,
    recommandations_carrieres: metiers,
    conseils_generaux: parsed.conseils_generaux || { recommandations: [] }
  };
}

// ----------------------------------------------------
// G√©n√©ration de l‚Äôintroduction
async function generateIntroduction(formulaire: any) {
  console.log("üöÄ Appel de generateIntroduction");
  try {
    const model = ai.getGenerativeModel({ model: "gemini-1.5-pro" });

    const prenom = formulaire.prenom;
    const genre = formulaire.genre;
    const phraseIntro =
      genre === "femme"
        ? `Voici le profil d‚Äôorientation de ${prenom}, elle est une adolescente pleine de potentiel.`
        : genre === "homme"
          ? `Voici le profil d‚Äôorientation de ${prenom}, il est un adolescent curieux et motiv√©.`
          : `Voici le profil d‚Äôorientation de ${prenom}, iel est une personne pleine de ressources.`;

    const prompt = `
Tu dois r√©pondre uniquement avec un objet JSON contenant une cl√© "introduction".
{
  "introduction": "${phraseIntro}"
}
`;

    const result = await model.generateContent({
      contents: [{ role: "user", parts: [{ text: prompt }] }],
      generationConfig: { responseMimeType: "application/json" }
    });

    const response = await result.response.text();
    console.log("üßæ √âtape intro (texte brut) :", response);

    try {
      return JSON.parse(response);
    } catch {
      // Fallback minimal si le JSON n‚Äôest pas strict
      return { introduction: phraseIntro };
    }
  } catch (error) {
    console.error("‚ùå Erreur dans generateIntroduction :", error);
    return { introduction: null };
  }
}

// ----------------------------------------------------
// G√©n√©ration du profil principal
async function generateProfilPrincipal(formulaire: any) {
  if (!ai) throw new Error("Gemini API non initialis√©e");

  const model = ai.getGenerativeModel({ model: "gemini-1.5-pro" }); // ‚úÖ stable

  const prenom = formulaire.prenom;
  const genre = formulaire.genre;

  const pronoms =
    genre === "femme"
      ? { il: "elle", le: "la", lui: "elle", son: "sa", sa: "sa", ses: "ses" }
      : genre === "homme"
        ? { il: "il", le: "le", lui: "lui", son: "son", sa: "sa", ses: "ses" }
        : { il: "iel", le: "le¬∑la", lui: "lui¬∑elle", son: "son¬∑sa", sa: "son¬∑sa", ses: "ses" };

  const phraseIntro =
    genre === "femme"
      ? `Voici le profil d‚Äôorientation de ${prenom}, elle est une adolescente pleine de potentiel.`
      : genre === "homme"
        ? `Voici le profil d‚Äôorientation de ${prenom}, il est un adolescent curieux et motiv√©.`
        : `Voici le profil d‚Äôorientation de ${prenom}, iel est une personne pleine de ressources.`;

  const phraseInspirante = `${prenom}, tu es capable de grandes choses. Garde confiance et avance avec courage.`;

  const prompt = `
Tu es un assistant d'orientation bienveillant et inspirant. Ton r√¥le est de r√©diger une analyse personnalis√©e du profil d‚Äôun¬∑e adolescent¬∑e.

‚ö†Ô∏è La premi√®re phrase doit obligatoirement √™tre :
"${phraseIntro}"



Accorde tous les pronoms au bon genre (${pronoms.il}, ${pronoms.le}, ${pronoms.lui}, ${pronoms.son}, ${pronoms.sa}, ${pronoms.ses}).

Sois chaleureux¬∑se, motivant¬∑e, et valorise les r√©ponses de l‚Äôado.


Termine par une phrase encourageante comme :
"${phraseInspirante}"

Voici les donn√©es du profil :

- Pr√©nom : ${prenom}
- Genre : ${genre}
- √Çge : ${formulaire.age}
- Localisation : ${formulaire.mobilite}
- Disponibilit√© : ${formulaire.disponibilite}
- Passions : ${[formulaire.passion1, formulaire.passion2, formulaire.passion3, formulaire.passion4, formulaire.passion5].filter(Boolean).join(", ")}
- Centres d‚Äôint√©r√™t : ${formulaire.interet?.join(", ")}
- Ce dont ${prenom} est fier¬∑e : ${formulaire.fierte}
- Ce qui le¬∑la freine : ${formulaire.freins}
- Citation personnelle : ${formulaire.citation}
- Objet choisi pour une √Æle d√©serte : ${formulaire.ileDeserte}
- Vid√©os pr√©f√©r√©es : ${formulaire.videos}
- Application magique imagin√©e : ${formulaire.appMagique}
- Style d‚Äôapprentissage : ${formulaire.apprentissage}
- Talents : ${formulaire.talents?.join(", ")}
- Comp√©tences : ${formulaire.competences?.join(", ")}
- Environnement pr√©f√©r√© : ${formulaire.environnement?.join(", ")}
- Valeurs : ${formulaire.valeurs_generales?.join(", ")}

Tu dois r√©pondre uniquement avec un objet JSON. Ne fais aucun commentaire. Ne commence pas par une phrase. Ne donne pas d‚Äôexplication. Juste le JSON.

‚ö†Ô∏è La cl√© "introduction" est obligatoire. Elle doit contenir exactement cette phrase :
"${phraseIntro}"

Voici le format attendu :


R√©ponds uniquement avec un objet JSON strictement conforme au format suivant :

{
  "introduction": "${phraseIntro}",
  "analyse_profil": {
    "paragraphe_intro": "...",
    "points_forts": "...",
    "freins": "...",
    "aspirations": "...",
    "conclusion": "..."
  },
  "message_inspirant": "${phraseInspirante}"
}
`;

  const result = await model.generateContent({
    contents: [{ role: "user", parts: [{ text: prompt }] }],
    generationConfig: { responseMimeType: "application/json" }
  });

  const response = await result.response.text();
  console.log("üßæ √âtape 1 - Profil principal :", response);

  try {
    return JSON.parse(response);
  } catch {
    // Fallback structur√© si le JSON n‚Äôest pas strict
    return {
      introduction: phraseIntro,
      analyse_profil: {
        paragraphe_intro: "",
        points_forts: "",
        freins: "",
        aspirations: "",
        conclusion: ""
      },
      message_inspirant: phraseInspirante
    };
  }
}

// ----------------------------------------------------
// G√©n√©ration des interpr√©tations
async function generateInterpretations(formulaire: any) {
  if (!ai) throw new Error("Gemini API non initialis√©e");

  const prenom = formulaire.prenom;
  const genre = formulaire.genre;

  const pronoms =
    genre === "femme"
      ? { il: "elle", le: "la", lui: "elle", son: "sa", sa: "sa", ses: "ses" }
      : genre === "homme"
        ? { il: "il", le: "le", lui: "lui", son: "son", sa: "sa", ses: "ses" }
        : { il: "iel", le: "le¬∑la", lui: "lui¬∑elle", son: "son¬∑sa", sa: "son¬∑sa", ses: "ses" };

  const model = ai.getGenerativeModel({ model: "gemini-2.5-flash" }); // ‚úÖ rapide

  console.log("üì• Donn√©es re√ßues pour interpr√©tation :", {
    ileDeserte: formulaire.ileDeserte,
    videos: formulaire.videos
  });

  let interpretation_ileDeserte = "Interpr√©tation non disponible";
  let interpretation_videos = "Interpr√©tation non disponible";

  try {
    const promptIle = `${prenom} a choisi comme objet pour une √Æle d√©serte : "${formulaire.ileDeserte || "Aucune s√©lection"}".
Explique ce que ce choix r√©v√®le sur ${pronoms.lui}. R√©ponds en une phrase claire et valorisante.`;

    const resultIle = await model.generateContent({
      contents: [{ role: "user", parts: [{ text: promptIle }] }]
    });

    interpretation_ileDeserte = (await resultIle.response.text()).trim();
    console.log("üß† R√©ponse brute √Æle d√©serte :", interpretation_ileDeserte);
  } catch (error) {
    console.error("‚ùå Erreur Gemini √Æle d√©serte :", error);
  }

  try {
    const promptVideos = `${prenom} a indiqu√© que ${pronoms.ses} vid√©os pr√©f√©r√©es sont : "${formulaire.videos || "Aucune s√©lection"}".
Explique ce que cela r√©v√®le sur ${pronoms.lui}. R√©ponds en une phrase claire et motivante.`;

    const resultVideos = await model.generateContent({
      contents: [{ role: "user", parts: [{ text: promptVideos }] }]
    });

    interpretation_videos = (await resultVideos.response.text()).trim();
    console.log("üé¨ R√©ponse brute vid√©os :", interpretation_videos);
  } catch (error) {
    console.error("‚ùå Erreur Gemini vid√©os :", error);
  }

  return {
    ileDeserte: formulaire.ileDeserte || "Aucune s√©lection",
    interpretation_ileDeserte,
    videos: formulaire.videos || "Aucune s√©lection",
    interpretation_videos
  };
}

// ----------------------------------------------------
// Fonction principale
export async function generateOrientationSuggestions(formulaire: any) {
  console.log("üöÄ Appel de generateOrientationSuggestions");
  console.log("üì• Donn√©es re√ßues :", formulaire);

  if (!ai) {
    console.log("üß™ Mode simul√© activ√©");
    return {
      introduction: null,
      analyse_profil: { resume: "Profil simul√©", points_forts: ["Cr√©atif", "Curieux"] },
      recommandations_carrieres: [],
      conseils_generaux: { recommandations: [] },
      ileDeserte: "Aucune s√©lection",
      interpretation_ileDeserte: "Interpr√©tation non disponible",
      videos: "Aucune s√©lection",
      interpretation_videos: "Interpr√©tation non disponible"
    };
  }

  try {
    console.log("üì§ Appel √† generateIntroduction...");
    const intro = await generateIntroduction(formulaire);
    console.log("‚úÖ Intro g√©n√©r√©e :", intro);

    console.log("üì§ Appel √† generateProfilPrincipal...");
    const profil = await generateProfilPrincipal(formulaire);
    console.log("‚úÖ Profil g√©n√©r√© :", profil);

    console.log("üì§ Appel √† generateInterpretations...");
    const interpretations = await generateInterpretations(formulaire);
    console.log("‚úÖ Interpr√©tations g√©n√©r√©es :", interpretations);

    const final = {
      ...normalizeGeminiResponse(profil),
      ...interpretations,
      introduction: intro.introduction || null
    };

    console.log("üì¶ R√©ponse fusionn√©e :", JSON.stringify(final, null, 2));
    console.log("‚úÖ Final avec intro :", final);

    return final;
  } catch (error: any) {
    const message = error?.message || "";
    if (message.includes("model is overloaded") || message.includes("503")) {
      console.error("‚ùå Le mod√®le Gemini est surcharg√©. R√©essaie plus tard.");
      throw new Error("Le mod√®le est temporairement indisponible. R√©essaie dans quelques instants.");
    }
    console.error("‚ùå Erreur Gemini :", error);
    throw new Error(`Erreur Gemini : ${message}`);
  }
}
