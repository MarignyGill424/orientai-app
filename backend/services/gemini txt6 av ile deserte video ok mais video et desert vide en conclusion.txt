import { GoogleGenerativeAI } from '@google/generative-ai';
import dotenv from "dotenv";
import path from "path";

dotenv.config({ path: path.resolve(process.cwd(), ".env") });

const GEMINI_API_KEY = process.env.GEMINI_API_KEY;
console.log("üîë Cl√© Gemini charg√©e :", GEMINI_API_KEY?.slice(0, 5));

if (!GEMINI_API_KEY) {
  console.warn("‚ö†Ô∏è Cl√© API Gemini manquante. R√©ponse simul√©e activ√©e.");
}

const ai = GEMINI_API_KEY ? new GoogleGenerativeAI(GEMINI_API_KEY) : null;

// ‚úÖ Fonctions d‚Äôinterpr√©tation
function interpreterIle(reponse?: string): string {
  const map: Record<string, string> = {
    "Carnet et crayon": "la cr√©ativit√© et l‚Äôintrospection",
    "Livre pr√©f√©r√©": "la curiosit√© et l‚Äô√©vasion",
    "Casque audio": "la sensibilit√© musicale",
    "Outil multifonction": "le pragmatisme et l‚Äôautonomie",
    "Objet sentimental": "l‚Äôattachement affectif",
    "Console portable": "le go√ªt du jeu et de l‚Äôimaginaire",
    "Application magique": "l‚Äôenvie de transformer le monde",
    "Animal de compagnie": "l‚Äôempathie et la fid√©lit√©",
    "Nourriture pr√©f√©r√©e": "le plaisir simple et la gourmandise",
    "Miroir ou objet symbolique": "la qu√™te de sens et d‚Äôidentit√©",
    "Autre": "un univers int√©rieur unique",
  };
  return map[reponse || ""] || "Interpr√©tation non disponible";
}

function interpreterVideos(reponse?: string): string {
  const map: Record<string, string> = {
    "Humour": "la cr√©ativit√© comique et la spontan√©it√©",
    "Sport": "l‚Äô√©nergie et l‚Äôesprit d‚Äô√©quipe",
    "Musique": "la sensibilit√© artistique et le rythme",
    "Science": "la curiosit√© intellectuelle",
    "S√©ries": "le go√ªt pour les histoires",
    "Films": "l‚Äôimaginaire et la narration",
    "Autre": "des int√©r√™ts originaux",
  };
  return map[reponse || ""] || "Interpr√©tation non disponible";
}

// ‚úÖ Fonction de normalisation
function normalizeGeminiResponse(parsed: any) {
  const rawMetiers = parsed.recommandations_carrieres || [];

  const metiers = rawMetiers.map((m: any) => ({
    titre: m.titre || "M√©tier sans titre",
    description: m.description || "",
    pourquoi_innovant_non_traditionnel: m.pourquoi_innovant_non_traditionnel || "",
    competences_cles: m.competences_cles || [],
    etapes_concretes: m.etapes_concretes || [],
  }));

  return {
    analyse_profil: parsed.analyse_profil || null,
    recommandations_carrieres: metiers,
    conseils_generaux: parsed.conseils_generaux || { recommandations: [] },
    ileDeserte: parsed.ileDeserte || "Aucune s√©lection",
    interpretation_ileDeserte: parsed.interpretation_ileDeserte || "Interpr√©tation non disponible",
    videos: parsed.videos || "Aucune s√©lection",
    interpretation_videos: parsed.interpretation_videos || "Interpr√©tation non disponible"
  };
}

// ‚úÖ Fonction principale
export async function generateOrientationSuggestions(formulaire: any) {
  if (!ai) {
    console.log("üß™ Mode simul√© activ√©");
    return {
      analyse_profil: {
        resume: "Profil simul√©",
        points_forts: ["Cr√©atif", "Curieux"]
      },
      recommandations_carrieres: [],
      conseils_generaux: { recommandations: [] },
      ileDeserte: "Aucune s√©lection",
      interpretation_ileDeserte: "Interpr√©tation non disponible",
      videos: "Aucune s√©lection",
      interpretation_videos: "Interpr√©tation non disponible"
    };
  }

  try {
    const model = ai.getGenerativeModel({ model: "gemini-2.5-flash" });

    const prompt = generatePrompt(formulaire);
    const result = await model.generateContent({
      contents: [{ role: "user", parts: [{ text: prompt }] }],
      generationConfig: {
        responseMimeType: "application/json"
      }
    });

    const response = result.response.text();
    console.log("üßæ R√©ponse brute Gemini :", response);

    const parsed = JSON.parse(response);
    const normalized = normalizeGeminiResponse(parsed);
    console.log("üì¶ R√©ponse normalis√©e :", JSON.stringify(normalized, null, 2));

    return normalized;
  } catch (error) {
    console.error("‚ùå Erreur Gemini :", error);
    throw new Error(`Erreur Gemini : ${(error as Error).message}`);
  }
}

// ‚úÖ Prompt enrichi
function generatePrompt(formData: any) {
  const enrichedForm = {
    ...formData,
    interpretation_ileDeserte: formData.ileDeserte
      ? interpreterIle(formData.ileDeserte)
      : "Interpr√©tation non disponible",
    interpretation_videos: formData.videos
      ? interpreterVideos(formData.videos)
      : "Interpr√©tation non disponible",
  };

  return `Tu es un expert en orientation professionnelle sp√©cialis√© dans l'accompagnement des jeunes. Analyse ce profil et g√©n√®re des recommandations de carri√®re personnalis√©es, en mettant l'accent sur les m√©tiers innovants et non-traditionnels.

PROFIL √Ä ANALYSER:
${JSON.stringify(enrichedForm, null, 2)}

Ta r√©ponse doit √™tre un objet JSON strict, sans texte explicatif ni introduction.

Inclue obligatoirement les champs suivants dans le JSON final, m√™me s‚Äôils sont vides :
- analyse_profil : { resume: string, points_forts: string[], axes_de_developpement?: string[] }
- recommandations_carrieres : Metier[]
- conseils_generaux : { recommandations: string[] }
- ileDeserte : string
- interpretation_ileDeserte : string
- videos : string
- interpretation_videos : string

Exemple de structure attendue :

{
  "analyse_profil": {
    "resume": "...",
    "points_forts": ["..."],
    "axes_de_developpement": ["..."]
  },
  "recommandations_carrieres": [
    {
      "titre": "...",
      "description": "...",
      "pourquoi_innovant_non_traditionnel": "...",
      "competences_cles": ["..."],
      "etapes_concretes": ["..."]
    }
  ],
  "conseils_generaux": {
    "recommandations": ["..."]
  },
  "ileDeserte": "Carnet et crayon",
  "interpretation_ileDeserte": "la cr√©ativit√© et l‚Äôintrospection",
  "videos": "Humour",
  "interpretation_videos": "la cr√©ativit√© comique et la spontan√©it√©"
}

Si ces champs sont absents ou non renseign√©s, indique :
- "Aucune s√©lection" pour les r√©ponses brutes
- "Interpr√©tation non disponible" pour les interpr√©tations

Ne mets rien avant ou apr√®s le JSON. Ne reformule pas. Ne commente pas. Ne justifie pas.`;
}
